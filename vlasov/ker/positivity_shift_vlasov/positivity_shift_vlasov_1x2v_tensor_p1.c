#include <gkyl_positivity_shift_vlasov_kernels.h> 
#include <math.h> 
#include <float.h> 

GKYL_CU_DH bool positivity_shift_vlasov_shift_only_1x2v_tensor_p1(double ffloor, double *distf) 
{ 
  // ffloor: Distribution function floor to shift to when f<0.
  // distf: distribution function.

  bool shifted = false;

  double fnod[8];
  fnod[0] = -(0.3535533905932737*distf[7])+0.3535533905932737*distf[6]+0.3535533905932737*distf[5]+0.3535533905932737*distf[4]-0.3535533905932737*distf[3]-0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[1] = 0.3535533905932737*distf[7]-0.3535533905932737*distf[6]-0.3535533905932737*distf[5]+0.3535533905932737*distf[4]+0.3535533905932737*distf[3]-0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[2] = 0.3535533905932737*distf[7]-0.3535533905932737*distf[6]+0.3535533905932737*distf[5]-0.3535533905932737*distf[4]-0.3535533905932737*distf[3]+0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[3] = -(0.3535533905932737*distf[7])+0.3535533905932737*distf[6]-0.3535533905932737*distf[5]-0.3535533905932737*distf[4]+0.3535533905932737*distf[3]+0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[4] = 0.3535533905932737*distf[7]+0.3535533905932737*distf[6]-0.3535533905932737*distf[5]-0.3535533905932737*distf[4]-0.3535533905932737*distf[3]-0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[5] = -(0.3535533905932737*distf[7])-0.3535533905932737*distf[6]+0.3535533905932737*distf[5]-0.3535533905932737*distf[4]+0.3535533905932737*distf[3]-0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[6] = -(0.3535533905932737*distf[7])-0.3535533905932737*distf[6]-0.3535533905932737*distf[5]+0.3535533905932737*distf[4]-0.3535533905932737*distf[3]+0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[7] = 0.3535533905932737*distf[7]+0.3535533905932737*distf[6]+0.3535533905932737*distf[5]+0.3535533905932737*distf[4]+0.3535533905932737*distf[3]+0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 

  // If f < 0. at check nodes, set it to ffloor.
  if (fnod[0] < 0.) {
    fnod[0] = ffloor;
    shifted = true;
  }
  if (fnod[1] < 0.) {
    fnod[1] = ffloor;
    shifted = true;
  }
  if (fnod[2] < 0.) {
    fnod[2] = ffloor;
    shifted = true;
  }
  if (fnod[3] < 0.) {
    fnod[3] = ffloor;
    shifted = true;
  }
  if (fnod[4] < 0.) {
    fnod[4] = ffloor;
    shifted = true;
  }
  if (fnod[5] < 0.) {
    fnod[5] = ffloor;
    shifted = true;
  }
  if (fnod[6] < 0.) {
    fnod[6] = ffloor;
    shifted = true;
  }
  if (fnod[7] < 0.) {
    fnod[7] = ffloor;
    shifted = true;
  }

  if (shifted) {
  distf[0] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[1] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[2] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[3] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[4] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[5] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[6] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[7] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  }

  return shifted;

}

GKYL_CU_DH bool positivity_shift_vlasov_MRS_limiter_1x2v_tensor_p1(double ffloor, double *distf) 
{ 
  // ffloor: Distribution function floor to shift to when f<0.
  // distf: distribution function.

  double fnod[8];
  fnod[0] = -(0.3535533905932737*distf[7])+0.3535533905932737*distf[6]+0.3535533905932737*distf[5]+0.3535533905932737*distf[4]-0.3535533905932737*distf[3]-0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[1] = 0.3535533905932737*distf[7]-0.3535533905932737*distf[6]-0.3535533905932737*distf[5]+0.3535533905932737*distf[4]+0.3535533905932737*distf[3]-0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[2] = 0.3535533905932737*distf[7]-0.3535533905932737*distf[6]+0.3535533905932737*distf[5]-0.3535533905932737*distf[4]-0.3535533905932737*distf[3]+0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[3] = -(0.3535533905932737*distf[7])+0.3535533905932737*distf[6]-0.3535533905932737*distf[5]-0.3535533905932737*distf[4]+0.3535533905932737*distf[3]+0.3535533905932737*distf[2]-0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[4] = 0.3535533905932737*distf[7]+0.3535533905932737*distf[6]-0.3535533905932737*distf[5]-0.3535533905932737*distf[4]-0.3535533905932737*distf[3]-0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[5] = -(0.3535533905932737*distf[7])-0.3535533905932737*distf[6]+0.3535533905932737*distf[5]-0.3535533905932737*distf[4]+0.3535533905932737*distf[3]-0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[6] = -(0.3535533905932737*distf[7])-0.3535533905932737*distf[6]-0.3535533905932737*distf[5]+0.3535533905932737*distf[4]-0.3535533905932737*distf[3]+0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 
  fnod[7] = 0.3535533905932737*distf[7]+0.3535533905932737*distf[6]+0.3535533905932737*distf[5]+0.3535533905932737*distf[4]+0.3535533905932737*distf[3]+0.3535533905932737*distf[2]+0.3535533905932737*distf[1]+0.3535533905932737*distf[0]; 

  bool shifted_node = false;

  if (distf[0] > 0.) {
    // Apply Moe–Rossmanith–Seal limiter.
    double fnod_min = DBL_MAX;
    fnod_min = fmin(fnod_min, fnod[0]);
    fnod_min = fmin(fnod_min, fnod[1]);
    fnod_min = fmin(fnod_min, fnod[2]);
    fnod_min = fmin(fnod_min, fnod[3]);
    fnod_min = fmin(fnod_min, fnod[4]);
    fnod_min = fmin(fnod_min, fnod[5]);
    fnod_min = fmin(fnod_min, fnod[6]);
    fnod_min = fmin(fnod_min, fnod[7]);

    if (fnod_min < 0.0) {
      double f_cellav = distf[0]/2.8284271247461907;
      double denom = f_cellav - fnod_min;
      double theta = denom > 1.0e-12*f_cellav? fmin(1.0, f_cellav/denom) : 1.0;

  distf[0] = -(2.8284271247461907*f_cellav*theta)+distf[0]*theta+2.8284271247461907*f_cellav; 
  distf[1] = distf[1]*theta; 
  distf[2] = distf[2]*theta; 
  distf[3] = distf[3]*theta; 
  distf[4] = distf[4]*theta; 
  distf[5] = distf[5]*theta; 
  distf[6] = distf[6]*theta; 
  distf[7] = distf[7]*theta; 

      shifted_node = true;
    }
  }

  else {

    // If f < 0. at check nodes, set it to ffloor.
    if (fnod[0] < 0.) fnod[0] = ffloor;
    if (fnod[1] < 0.) fnod[1] = ffloor;
    if (fnod[2] < 0.) fnod[2] = ffloor;
    if (fnod[3] < 0.) fnod[3] = ffloor;
    if (fnod[4] < 0.) fnod[4] = ffloor;
    if (fnod[5] < 0.) fnod[5] = ffloor;
    if (fnod[6] < 0.) fnod[6] = ffloor;
    if (fnod[7] < 0.) fnod[7] = ffloor;

  distf[0] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[1] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[2] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[3] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 
  distf[4] = 0.3535533905932737*fnod[7]+0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[5] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]+0.3535533905932737*fnod[5]-0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[6] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]+0.3535533905932737*fnod[3]-0.3535533905932737*fnod[2]-0.3535533905932737*fnod[1]+0.3535533905932737*fnod[0]; 
  distf[7] = 0.3535533905932737*fnod[7]-0.3535533905932737*fnod[6]-0.3535533905932737*fnod[5]+0.3535533905932737*fnod[4]-0.3535533905932737*fnod[3]+0.3535533905932737*fnod[2]+0.3535533905932737*fnod[1]-0.3535533905932737*fnod[0]; 

    shifted_node = true;
  }

  return shifted_node;

}
